// Generated by CoffeeScript 1.4.0

define(['jquery', 'kinetic', 'tools'], function($, K, tools) {
  var PlayLevel, words;
  words = [
    {
      char: '你',
      piny: 'nǐ',
      ascii: 'ni',
      ans: '3',
      def: 'you'
    }, {
      char: '是',
      piny: 'shì',
      ascii: 'shi',
      ans: '4',
      def: 'is, to be'
    }, {
      char: '他',
      piny: 'tā',
      ascii: 'ta',
      ans: '1',
      def: 'him, he'
    }, {
      char: '狗肉',
      piny: 'gǒu ròu',
      ascii: 'gou rou',
      ans: '34',
      def: 'dog meat, something very stinky or repulsive'
    }, {
      char: '否',
      piny: 'fǒu',
      ascii: 'fou',
      ans: '3',
      def: 'otherwise, or else'
    }
  ];
  return PlayLevel = (function() {

    function PlayLevel(game, layer, level) {
      var baseLayer;
      this.game = game;
      this.layer = layer;
      baseLayer = this.layer;
      this.stage = this.game.stage;
      this.grayText = '#454545';
      this.blackText = '#000000';
      console.log("stage is", this.stage);
      this.playing = true;
      this.score = 1;
      this.combo = 1;
      this.w = this.stage.getWidth();
      this.h = this.stage.getHeight();
      this.scoreLayer = new K.Layer();
      this.drawScores(this.scoreLayer);
      this.drawTones(this.scoreLayer);
      this.cardsLayer = new K.Layer();
      this.drawCards(this.cardsLayer);
      this.drawActiveCard(this.cardsLayer);
      this.stage.add(this.scoreLayer);
      this.stage.add(this.cardsLayer);
    }

    PlayLevel.prototype.drawScores = function(layer) {
      var score;
      layer.removeChildren();
      score = new K.Text({
        x: this.w * 0.05,
        y: this.h * 0.05,
        text: this.score,
        fontSize: this.h * 0.1,
        fontFamily: 'karatemedium',
        fill: 'white',
        align: 'left',
        width: this.w * 0.5,
        padding: 5
      });
      layer.add(score);
      return layer.draw();
    };

    PlayLevel.prototype.drawTones = function(layer) {
      return console.log("draw tones");
    };

    PlayLevel.prototype.getCard = function(_arg) {
      var ascii, card, center, char, def, draggable, fullWord, height, left, name, paper, randX, randY, top, width, word;
      name = _arg.name, draggable = _arg.draggable, word = _arg.word;
      if (draggable == null) {
        draggable = false;
      }
      if (word == null) {
        word = words[parseInt(Math.floor(Math.random() * words.length))];
      }
      console.log(word, draggable);
      card = new K.Group({
        draggable: draggable
      });
      randX = Math.random();
      randY = Math.random();
      top = 0.2 + randY * 0.05;
      center = 0.5 + randX * 0.05;
      width = 0.8;
      height = 0.8;
      left = center - width * 0.5;
      paper = tools.createRect({
        stage: this.stage,
        top: top,
        left: left,
        width: width,
        marginLeft: 0,
        marginTop: 0.0,
        height: 'square',
        name: name,
        fill: '#f2f2ea',
        stroke: 'none',
        strokeWidth: 0
      });
      tools.addShadow(paper);
      char = new K.Text({
        y: top * this.h + 0.15 * width * this.w,
        x: center * this.w - (0.3 * this.w),
        text: word.char,
        fontSize: 0.75 * width * this.w,
        fontFamily: 'arial',
        fill: this.blackText,
        align: 'center',
        width: 0.75 * width * this.w,
        padding: 0
      });
      console.log('no padding 3');
      ascii = new K.Text({
        y: top * this.h + 0.82 * width * this.w,
        x: (0.5 + randX * 0.05) * this.w - (0.3 * this.w),
        text: word.ascii,
        fontSize: 0.15 * width * this.w,
        fontFamily: 'arial',
        fill: this.grayText,
        align: 'center',
        width: 0.6 * this.w,
        padding: 0
      });
      def = new K.Text({
        y: top * this.h,
        x: left * this.w,
        text: word.def,
        fontSize: Math.max(10, 0.04 * width * this.w),
        fontFamily: 'arial',
        fill: this.grayText,
        align: 'left',
        width: 0.5 * width * this.w,
        padding: 0.05 * width * this.w
      });
      fullWord = new K.Text({
        y: top * this.h,
        x: center * this.w,
        text: word.char,
        fontSize: 0.08 * width * this.w,
        fontFamily: 'arial',
        fill: this.grayText,
        align: 'right',
        width: 0.5 * width * this.w,
        padding: 0.05 * width * this.w
      });
      card.word = word;
      card.add(paper);
      card.add(char);
      card.add(ascii);
      card.add(def);
      card.add(fullWord);
      card.setSize(paper.getSize());
      return card;
    };

    PlayLevel.prototype.drawCards = function(layer) {
      var card, i, _i, _results;
      console.log("now stage is", this.stage);
      this.cards = [];
      _results = [];
      for (i = _i = 0; _i <= 5; i = ++_i) {
        card = this.getCard({
          name: 'card' + i
        });
        this.cards.push(card);
        _results.push(layer.add(card));
      }
      return _results;
    };

    PlayLevel.prototype.startDrag = function() {
      var _this = this;
      this.dragStartTime = (new Date()).getTime();
      this.dragPositions = [
        {
          x: this.activeCard.getX(),
          y: this.activeCard.getY()
        }
      ];
      return this.dragInterval = setInterval(function() {
        _this.dragStartTime = (new Date()).getTime();
        _this.dragPositions.push({
          x: _this.activeCard.getX(),
          y: _this.activeCard.getY()
        });
        if (_this.dragPositions.length > 3) {
          return _this.dragPositions.slice(0, 1);
        }
      }, 50);
    };

    PlayLevel.prototype.endDrag = function() {
      var ans, bottomTime, c, dragEndPos, dragEndTime, finalXPos, finalYPos, leftTime, numPositions, overThresholdX, overThresholdY, rightTime, topTime, v, xFriction, xVel, yFriction, yVel,
        _this = this;
      clearInterval(this.dragInterval);
      dragEndTime = (new Date()).getTime();
      dragEndPos = {
        x: this.activeCard.getX(),
        y: this.activeCard.getY()
      };
      numPositions = this.dragPositions.length;
      xVel = 0;
      yVel = 0;
      if (numPositions >= 2) {
        xVel = (this.dragPositions[numPositions - 1].x - this.dragPositions[numPositions - 2].x) / 0.1;
        yVel = (this.dragPositions[numPositions - 1].y - this.dragPositions[numPositions - 2].y) / 0.1;
      } else {
        xVel = (this.dragPositions[0].x - dragEndPos.x) * 1000.0 / (this.dragStartTime - dragEndTime);
        yVel = (this.dragPositions[0].y - dragEndPos.y) * 1000.0 / (this.dragStartTime - dragEndTime);
      }
      xVel = xVel / this.w;
      yVel = yVel / this.h;
      console.log(xVel, yVel);
      xFriction = 0.20;
      yFriction = 0.20;
      overThresholdX = 0;
      overThresholdY = 0;
      if (Math.abs(xVel) > 0.1) {
        console.log("flick off X, motherflicker!");
        overThresholdX = 1;
      }
      if (Math.abs(yVel) > 0.1) {
        console.log("flick off Y, motherflicker!");
        overThresholdY = 1;
      }
      if (overThresholdY || overThresholdX) {
        finalXPos = xVel * 3;
        finalYPos = yVel * 3;
        finalXPos = finalXPos < 2.0 && finalXPos > 0.0 ? 2.0 : finalXPos > -2.0 && finalXPos < 0.0 ? -2.0 : finalXPos;
        finalYPos = finalYPos < 2.0 && finalYPos > 0.0 ? 2.0 : finalYPos > -2.0 && finalYPos < 0.0 ? -2.0 : finalYPos;
        this.activeCard.transitionTo({
          x: this.activeCard.getX() + (finalXPos * this.w) * overThresholdX,
          y: this.activeCard.getY() + (finalYPos * this.h) * overThresholdY,
          duration: 0.2,
          easing: 'ease-in-out'
        });
        c = {
          x: this.activeCard.getX() + this.activeCard.getWidth() / 2,
          y: this.activeCard.getY() + this.activeCard.getHeight() / 2
        };
        v = {
          x: xVel,
          y: yVel
        };
        console.log(c.y, v.y);
        topTime = v.y !== 0 ? (0 - c.y) / v.y : -1;
        console.log("Top Time is", topTime);
        bottomTime = v.y !== 0 ? (this.h - c.y) / v.y : -1;
        console.log("Bottom Time is", bottomTime);
        leftTime = v.x !== 0 ? (0 - c.x) / v.x : -1;
        rightTime = v.x !== 0 ? (-this.w - c.x) / v.x : -1;
        console.log("topTime", topTime, "bottomTime", bottomTime);
        ans = '0';
        if (v.y < 0) {
          if (Math.abs(v.x) > Math.abs(v.y)) {
            if (v.x < 0) {
              console.log("LEFT!");
              ans = '4';
            } else {
              console.log("RIGHT!");
              ans = '2';
            }
          } else {
            console.log("TOP!");
            ans = '1';
          }
        } else {
          if (Math.abs(v.x) > Math.abs(v.y)) {
            if (v.x < 0) {
              console.log("LEFT!");
              ans = '4';
            } else {
              console.log("RIGHT!");
              ans = '2';
            }
          } else {
            console.log("BOTTOM!");
            ans = '3';
          }
        }
        this.checkAnswer(ans, this.activeCard.word);
        return setTimeout(function() {
          return _this.drawActiveCard(_this.cardsLayer);
        }, 0.1);
      }
    };

    PlayLevel.prototype.checkAnswer = function(tone, word) {
      console.log("checkAnswer", tone, word.ans);
      if (tone === word.ans.charAt(0)) {
        this.score += 1 * parseInt(Math.max(this.combo / 2, 1));
        this.combo += 1;
        console.log("JIAYOU!!!!");
        this.drawScores(this.scoreLayer);
        return console.log(this.score);
      } else {
        return this.combo = 1;
      }
    };

    PlayLevel.prototype.drawActiveCard = function(layer) {
      var card,
        _this = this;
      this.activeCard = this.cards.pop();
      card = this.activeCard;
      card.setDraggable(true);
      console.log("ACTIVE CARD IS", card);
      card.on('dragstart', function() {
        return _this.startDrag();
      });
      return card.on('dragend', function(e) {
        e.stopPropagation();
        if (_this.dragInterval) {
          return _this.endDrag();
        }
      });
    };

    return PlayLevel;

  })();
});
